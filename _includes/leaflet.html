<div id="map" style="height: 75vh; width: 100%;">

</div>

<hr />

<span id="customLinkSpan" style="height: 2vh; width: 100%;"><a id="customLinkA">Get Your Custom Link</a></span>

<style>
    .wrapper {
        max-width: 80%;
    }
</style>

<script>
    var countries = {{ site.data.countries | jsonify }};
    var countriesVisited = [];

    const selectedColor = "#ff0000";

    const urlS = new URLSearchParams(window.location.search);

    urlS.forEach(function(value, key) {
        console.log(key, value);
        countriesVisited.push(key);
    });

    document.getElementById("customLinkA").href = "/" + buildQueryString();
    
    document.body.style.zoom = 1.0000001;
    setTimeout(function(){document.body.style.zoom = 1;},50); //allow some time to flush the css buffer.
    var map = L.map('map').setView([45,0], 3);
    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    

    function buildQueryString() {
        var queryString = "?";
        for (const country in countriesVisited) {
            queryString += countriesVisited[country] + "=Y&";
        }
        return queryString.slice(0, -1);
    }

    function countryClicked(e) {
        if (countriesVisited.includes(e.target.feature.properties["ISO_A3"])) {
            countriesVisited.splice(countriesVisited.indexOf(e.target.feature.properties["ISO_A3"]), 1);
            e.target.setStyle({
                fillColor: null
            });
        } else {
            countriesVisited.push(e.target.feature.properties["ISO_A3"]);
            console.log(e.target.feature.properties["ISO_A3"]);
            e.target.setStyle({
                fillColor: selectedColor
            });
        }
        window.history.pushState("object or string", "Title", "/" + buildQueryString());
        document.getElementById("customLinkA").href = "/" + buildQueryString();
    }

    function onEachFeature(feature, layer) {
        if (countriesVisited.includes(feature.properties["ISO_A3"])) {
            layer.setStyle({
                fillColor: selectedColor
            });
        }
        layer.on({
            click: countryClicked
        });
    }

    geoJSON = L.geoJSON(countries, {
        onEachFeature: onEachFeature
    }).addTo(map);
    
</script>
